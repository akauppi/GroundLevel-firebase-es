#
# docker-compose.yml
#
# For:
#   - manual deployment
#   - getting the access values to 'firebase.${ENV-staging}.js'
#
# Docker Compose (v3) note:
#   BE CAREFUL with use of pipe ('|') or '&&' in the commands! See -> https://stackoverflow.com/a/68590318/14455
#
# References:
#   Overview of Docker Compose (Docker docs)
#     -> https://docs.docker.com/compose/
#   Compose file version 3 reference
#     -> https://docs.docker.com/compose/compose-file/compose-file-v3/
#
services:
  # Usage:
  #   <<
  #     $ install -d tmp/configstore     # important on WSL2 (otherwise 'root')
  #     $ touch tmp/.captured.sdkconfig tmp/.firebaserc
  #     $ docker compose run --service-ports --rm deploy-auth
  #   <<
  #
  # Let the user authenticate (via a host-side browser session) and select the right Firebase deployment project.
  #
  # Note:
  #   This needs to be 'run' (not started as a service): Firebase needs an interactive terminal for project selection.
  #
  # Once authenticated, the auth information is stored in: 
  #   'tmp/configstore/firebase-tools.json'
  #
  # 'firebase use --add' demands to have a 'firebase.json' (a dummy will do) and creates '.firebaserc' in the
  # current folder.
  #
  deploy-auth:
    build: ../firebase-ci-builder.sub
    ports:
      - "9005:9005"   # needed by the auth dance
    volumes:
      #-- RO
      #-- Output
      #
      # Firebase CLI saves the login information in '/root/.config/configstore/firebase-tools.json'.
      # It also creates '/root/.config/configstore/update-notifier-firebase-tools.json'.
      #
      - ./.state/configstore:/root/.config/configstore:rw
      - ./.state/.captured.sdkconfig:/work/.captured:delegated
      - ./.state/.firebaserc:/work/.firebaserc:delegated

    working_dir: /work
    command: bash -o pipefail -c
      'echo "Launching Docker... ðŸ³" &&
      
      echo '{}' > firebase.json &&
      firebase login &&

      firebase use --add &&
      (firebase apps:sdkconfig > .captured)
      '

    profiles: ['manual']

  # Run before 'deploy-backend'. Prepares the Function dependencies.
  #
  # Note: Kept separate from 'deploy-backend' because we don't want to eternally rely on the Firebase Emulators
  #     having 'npm' capability. They are conceptually different.
  #
  #     Not done on the host side, because we don't want the 'functions/node_modules' to be visible.
  #
  prepare-backend-state:
    image: node:16-alpine
    volumes:
      #-- RO
      - ../packages/backend/functions/package.json:/work/functions/package.json:ro
      #-- output
      - ./.state/functions-node_modules:/work/functions/node_modules:delegated

    working_dir: /work/functions
    command: sh -c
      'npm config set update-notifier false &&
      echo package-lock=false > .npmrc &&

      npm install --no-optional
      '
    environment:
    - NO_GUARD=1
    profiles: ['manual']

  # Usage:
  #   <<
  #     docker compose run --rm deploy-backend
  #   <<
  #
  deploy-backend:
    build: ../firebase-ci-builder.sub
    volumes:
      #-- RO
      - ../packages/backend/functions:/work/functions:ro
      - ../packages/backend/firestore.indexes.json:/work/firestore.indexes.json:ro
      - ../packages/backend/firestore.rules:/work/firestore.rules:ro
      #
      # Note: Caller has generated these.
      #   Though they are created in a 'tmp' folder, also 'backend' uses DC mapping, to place them in the work folder.
      #   This suits us well.
      #
      - ../packages/backend/tmp/firebase.json:/work/firebase.json:ro
      - ../packages/backend/tmp/database.rules.json:/work/database.rules.json:ro
      #
      - ./.state/.firebaserc:/work/.firebaserc:ro
      - ./.state/functions-node_modules:/work/functions/node_modules:ro

      #-- other
      # Note: 'configstore' needs to be writable for 'firebase deploy' to not hick up (no changes are anticipated).
      - ./.state/configstore:/root/.config/configstore:rw

    working_dir: /work
    command: sh -c
      'firebase deploy --only functions,firestore,database
      '
    profiles: ['manual']

  # Usage:
  #   <<
  #     docker compose run --rm deploy-app
  #   <<
  #
  # Context:
  #   - the app has been recently built (only 'dist' contents are deployed)
  #
  deploy-app:
    build: ../firebase-ci-builder.sub
    volumes:
      #-- RO
      - ../packages/app/dist:/work/dist:ro
      - ../packages/app/firebase.json:/work/firebase.json:ro
      #
      # Note: 'configstore' needs to be writable for 'firebase deploy' to not hick up.
      - ./.state/configstore:/root/.config/configstore:rw
      - ./.state/.firebaserc:/work/.firebaserc:ro
    working_dir: /work
    command: sh -c
      'firebase deploy --only hosting
      '
    profiles: ['manual']
