#
# docker-compose.yml
#
# For:
#   - manual deployment of backend and front-end
#   - getting the access values to 'firebase.${ENV-staging}.js'
#
# Usage:
#   <<
#     $ CAPTURE_FILE=... docker compose run --service-ports all
#   <<
#
# Docker Compose (v3) note:
#   BE CAREFUL with use of pipe ('|') or '&&' in the commands! See -> https://stackoverflow.com/a/68590318/14455
#
# References:
#   Overview of Docker Compose (Docker docs)
#     -> https://docs.docker.com/compose/
#   Compose file version 3 reference
#     -> https://docs.docker.com/compose/compose-file/compose-file-v3/
#
services:
  deploy:
    build: ../firebase-ci-builder.sub
    ports:
      - "9005:9005"
      # 9005 is needed by the auth dance
    volumes:
      - ..:/proj
    working_dir: /proj
    command: bash -o pipefail -c
      'echo "Launching Docker... 🐳" &&
      firebase login
        &&
      (cd packages/backend && firebase use --add) &&
      (cd packages/app && firebase use $$(cd ../backend && firebase use)) &&
      #(cd packages/backend && firebase apps:sdkconfig) > ${CAPTURE_FILE}
        &&
      (cd packages/backend && npm install && firebase deploy --only functions,firestore) &&
      (cd packages/app &&     npm install && npm run build && firebase deploy --only hosting)
      '
    profiles: ['manual']

  # tbd. Is the '> ${CAPTURE_FILE}' needed? #rework
