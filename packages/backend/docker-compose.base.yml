#
# backend/docker-compose.base.yml
#
# Base for 'docker-compose[.app].yml (and via them, to 'docker-compose[.app].ci.yml').
#
# Expects:
#   - 'PROJECT_ID' to be given ('demo-2' for backend; 'demo-main' for app).
#   - 'DOT_APP' to be ".app" (for app) or not given (backend)
#   - 'LOGS_PATH' can be used for placing (app) logs away from the backend's
#
# Note:
#   DC overlays do allow for removal of mounts (e.g. by overriding them to point to '/dev/nul'; mounts are overridable
#   by their container side path as a key). But that would be too fine-grained. This file just provides the common
#   things for both '(nothing)' and 'app' and they add their specific mounts.
#
# Intentions:
#   Launch the emulators, with configuration generated by 'firebase[.app].js'.
#
# Docker Compose (v3) note:
#   BE CAREFUL with use of pipe ('|') or '&&' in the commands! See -> https://stackoverflow.com/a/68590318/14455
#
# References:
#   Overview of Docker Compose (Docker docs)
#     -> https://docs.docker.com/compose/
#   Compose file version 3 reference
#     -> https://docs.docker.com/compose/compose-file/compose-file-v3/
#
services:
  #
  # Expects:
  #   - 'LOGS_PATH' to be defined (examples: './logs', './logs.app')
  #   - 'DOT_APP' to be defined as ".app" for App backend
  #
  emul-base:   # used for 'npm run start', 'npm test', 'npm run app:start'
    extends:
      file: ../../dc/firebase-emulators/base.yml
      service: base
    volumes:
      # --- RO
      - ./tmp/firebase${DOT_APP:-}.json:/work/firebase.json:ro
      # --- cached (may change; watched by the Emulators)
      - ./functions:/work/functions:cached
      - ./firestore.indexes.json:/work/firestore.indexes.json:cached
      - ./firestore.rules:/work/firestore.rules:cached
      - ./tmp/database.rules.json:/work/database.rules.json:cached    # could get recreated on the host (or manually tweaked)
      # --- output
      - ${LOGS_PATH}/firebase-debug.log:/work/firebase-debug.log:delegated
      - ${LOGS_PATH}/firestore-debug.log:/work/firestore-debug.log:delegated
      - ${LOGS_PATH}/database-debug.log:/work/database-debug.log:delegated
      - ${LOGS_PATH}/ui-debug.log:/work/ui-debug.log:delegated
      # --- other
      - ./tmp/functions/node_modules:/work/functions/node_modules:ro

    working_dir: /work
    environment:
      - CHOKIDAR_USEPOLLING=true
        # Allows emulators to see changes to (host side, volume mapped) Security Rules, Cloud Functions

    # If we provide ports by Env.vars, could have also health check here.
    #|healthcheck:
    #|  test: "nc -z localhost 6767 && nc -z localhost 5002 && nc -z localhost 6800 && sleep 2"
    #|  # Note: 'nc' in that image doesn't handle checking multiple ports at once.
    #|  interval: 0.7s
    #|  start_period: 23s
