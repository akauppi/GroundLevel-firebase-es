#
# backend/docker-compose.ci.yml
#
# Takes the role of both 'docker-compose.base.yml' and 'docker-compose.yml', for CI.
# Works as a basis for 'docker-compose.ci.app.yml'.
#
# Reasons:
#   - in CI, we don't need separate emulator instances for backend and front-end (same can handle both)
#   - in CI, we always run on Linux, so don't need the 'tmp/functions-node_modules' tricks, done in development (simpler)
#   - !! separating development and CI causes some overlap, but also frees the implementations from breaking each other!!
#   - uses a pre-built image instead of pointing to '../dc/', as development does.
#
# Expects:
#   CI_BUILDER_IMAGE  to provide the name of the Docker image to use
#   FIRESTORE_PORT
#   FUNCTIONS_PORT
#   DATABASE_PORT
#
services:
  emul:
    image: ${CI_BUILDER_IMAGE}
    ports:
      - "${FUNCTIONS_PORT}:${FUNCTIONS_PORT}"
      - "${FIRESTORE_PORT}:${FIRESTORE_PORT}"
      - "${DATABASE_PORT}:${DATABASE_PORT}"
        # Keep ports aligned with 'firebase.js' (also used for CI)

    volumes:
      # --- RO
      - ./tmp/firebase.json:/work/firebase.json:ro
      - ./tmp/database.rules.json:/work/database.rules.json:ro
      - ./firestore.indexes.json:/work/firestore.indexes.json:ro
      - ./firestore.rules:/work/firestore.rules:ro
      - ./functions:/work/functions:ro

    working_dir: /work
    command: sh -c
      'echo "Launching Docker... üê≥" &&
      
      cat firebase.json &&

      firebase emulators:start --project=demo-2
        | grep -v -E "You are not currently authenticated|Detected demo project ID|You are not signed in to the Firebase CLI|The Emulator UI is not starting"
      '
        # Note: The '--project' parameter does not matter, but Firebase Emulators demands to have one (11.2.0).
        #     It only steers which project is visible in the UI, and since we run in CI, there is no UI.

    healthcheck:
      # Note: For some reason '${DATABASE_PORT}' does not get opened. But we don't need it, either.
      test: '
        nc -z localhost ${FIRESTORE_PORT} &&
        nc -z localhost ${FUNCTIONS_PORT}
        '
          # Note: 'nc' in that image doesn't handle checking multiple ports at once.
      interval: 0.5s
      start_period: 30s

    # Allows the ports to be seen (as 'emul:{port}') by Cloud Build steps.
    #
    network_mode: cloudbuild
    container_name: emul

  emul-is-healthy:
    image: node:16-alpine
    command: sh -c true
    depends_on:
      emul:
        condition: service_healthy

    container_name: emul-is-up    # just for the logs
    profiles: ['manual']
