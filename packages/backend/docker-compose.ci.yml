#
# backend/docker-compose.ci.yml
#
# Takes the role of both 'dc.base.yml' and 'docker-compose.yml', for CI.
# Works as a basis for 'docker-compose.app.ci.yml'.
#
# Reasons:
#   - in CI, we don't need separate emulator instances for backend and front-end (same can handle both)
#   - in CI, we always run on Linux, so don't need the 'tmp/functions-node_modules' tricks, done in development (simpler)
#   - !! separating development and CI causes some overlap, but also frees the implementations from breaking each other!!
#   - uses a pre-built image instead of pointing to '../dc/', as development does.
#
# Expects:
#   CI_BUILDER_IMAGE  to provide the name of the Docker image to use
#
services:
  emul:
    image: ${CI_BUILDER_IMAGE}
    # Ports not needed; tests will run directly against 'emul' (or 'emul-for-app') hostname.

    volumes:
      # --- RO
      - ./tmp/firebase.ci.json:/work/firebase.json:ro
      - ./firestore.indexes.json:/work/firestore.indexes.json:ro
      - ./firestore.rules:/work/firestore.rules:ro
      - ./functions:/work/functions:ro
      # --- Output
      # Getting log files to the Cloud Build folder can be used for debugging.
      #
      - ./firebase-debug.log:/work/firebase-debug.log:delegated
      - ./firestore-debug.log:/work/firestore-debug.log:delegated
    environment:
      - PROJECT_ID=demo-2

    working_dir: /work
    command: sh -c '
      echo "Launching Docker... üê≥" &&
      
      firebase emulators:start --project=$$PROJECT_ID
        | grep -v -E "You are not currently authenticated|Detected demo project ID|You are not signed in to the Firebase CLI|The Emulator UI is not starting"
      '
      # Note: The project id must match that used by Cloud Functions ('test-fns/setup.jest.js').

    healthcheck:
      test: '
        nc -z localhost 6767 &&
        nc -z localhost 5002
      '
        # tbd. read ports (and whether auth is enabled) from 'tmp/firebase.ci.json'; enable app & database check
        #
        # Note: 'nc' in that image doesn't handle checking multiple ports at once.
      interval: 0.5s
      start_period: 30s

    # Allows the ports to be seen (as 'emul:{port}') by Cloud Build steps.
    #
    network_mode: cloudbuild
    container_name: emul

  emul-is-healthy:
    image: node:16-alpine
    command: sh -c true
    depends_on:
      emul:
        condition: service_healthy

    container_name: emul-is-healthy    # just for the logs
    profiles: ['manual']
