#
# app/docker-compose.local.yml
#
# Overlay, for 'npm run dev:local' specificity.
#
services:
  vite-dev:
    extends:
      file: dc.base.yml
      service: vite-base

    volumes:
      # --- RO
      - ./tools/gen-vite-env-local.js:/work/tools/gen-vite-env-local.js:ro
      - ../backend/firebase.app.js:/work/firebase.app.js:ro
      - ./.env.dev_local:/work/.env.local:ro
    environment:
      - MODE=local

    healthcheck:
      test: "nc -z localhost $PORT"
      interval: 0.9s
      start_period: 25s
    profiles: ['manual']

  # 'npm test' uses this, to have 'vite-dev' run in the background
  #
  vite-dev-launched:
    image: node:16-alpine
    command: sh -c true
    depends_on:
      vite-dev:
        condition: service_healthy
    profiles: ['manual']

  #---
  # This is normally not needed, but CAN BECOME USEFUL if 'main.js' doesn't launch 'app.js' properly, to debug.
  #
  # Used via 'npm run _build:dev'
  #
  # tbd. Undocumented; broken. Fix. May be useful!
  #
#|  build:
#|    extends:
#|      file: dc.base.yml
#|      service: vite-base
#|
#|    volumes:
#|      # --- RO
#|      - ./tools/gen-vite-env-local.js:/work/tools/gen-vite-env-local.js:ro
#|      - ./.env.dev_local:/work/.env.local:ro
#|    command: sh -c
#|      'npm config set update-notifier false &&
#|
#|      npm install -g rollup-plugin-visualizer &&
#|      (cd / && mkdir node_modules && cd node_modules && ln -s $$NODE_PATH/rollup-plugin-visualizer .) &&
#|
#|      ([ -z "${SENTRY_SAMPLE_RATE:-}" ] || echo "VITE_SENTRY_SAMPLE_RATE=${SENTRY_SAMPLE_RATE:---}" >> .env) &&
#|
#|      vite build --mode dev_local
#|      '
#|    environment:
#|      - MODE=local
#|    profiles: ['manual']
