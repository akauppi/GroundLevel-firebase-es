#
# docker-compose.ci.yml
#
# Tools for CI test runs (Cloud Build).
#
# _Similar_ to 'dc.base.yml' and 'docker-compose.local.yml' but separate. Changes here will not break development
# experience, and vice versa. However, we still use the same Vite version, defined under 'tools/vite.dc/'.
#
# Expects:
#   - PORT to declare the port to show UI in
#
# To debug locally:
#   - temporarily comment out the 'network_mode' and 'container_name' fields.
#
# References:
#   - Share Compose configurations between files and projects (Docker Compose docs)
#     -> https://docs.docker.com/compose/extends/
#
services:
  vite-ci:
    build:
      context: tools/vite.dc
      target: vite_plain        # also builds are done with this; CI does not need visualizations
    ports:
      - "$PORT:$PORT"
    volumes:
      # --- RO
      - ./node_modules:/work/node_modules:ro
      - ./public:/work/public:ro
      - ./src:/work/src:ro
      - ./dev:/work/dev:ro
      - ./package.json:/work/package.json:ro              # 'ci:launch' is there
      - ./tmp/.env.ci_test:/work/.env:ro
      #
      - ./vite.config.js:/work/vite.config.js:ro
      - ./rollup.chunks.js:/work/rollup.chunks.js:ro
      - ../../branding/favicon.png:/branding/favicon.png:ro   # trick to make the 'ln -s' work

    working_dir: /work
    command: sh -c '
      npm config set update-notifier false &&
  
      npm run ci:launch
      '
    environment:
      - MODE=local    # tbd. is this needed??
      - PORT              # pass through, at least 'vite.config.js' wants it

    network_mode: cloudbuild
    container_name: vite
      # The domain node name (not 'localhost'!) to use for the front end, e.g. 'http://vite:3002'

    healthcheck:
      test: "nc -z localhost $PORT"
      interval: 0.9s
      start_period: 20s

  # Make sure Vite is launched.
  #
  vite-ci-launched:
    image: node:16-alpine
    command: sh -c true
    depends_on:
      vite-ci:
        condition: service_healthy

    profiles: ['manual']
    container_name: vite-ci-launched    # just for logs
