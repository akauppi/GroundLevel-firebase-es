#
# app/docker-compose.tools.prod.yml
#
services:
  #---
  # Build production delivery (manually)
  #
  # Expects:
  #   - ENV
  #   - SENTRY_DSN (optional)
  #   - SENTRY_SAMPLE_RATE (optional)
  #
  build:
    build:
      context: tools/vite.dc
      target: vite_extras
    volumes:
      # --- RO
      - ./node_modules:/work/node_modules:ro         # note: should not have 'esbuild' in it
      - ./vite.config.js:/work/vite.config.js:ro     # Vite needs a restart to see config changes, thus 'ro'.
      - ./rollup.chunks.js:/work/rollup.chunks.js:ro
      - ../../firebase.${ENV:-staging}.js:/work/firebase.config.js:ro
      # --- RO (since we're a task)
      - ./src:/work/src:ro
      - ./prod:/work/prod:ro
      - ./public:/work/public:ro
      # --- Output
      - ./dist:/work/dist:delegated
      - ./stats.html:/work/stats.html:delegated
      # --- other
      - ../../../branding/favicon.png/:/work/public/favicon.png:ro
      - ./tmp/.vite:/work/tmp/.vite:delegated    # persistence between runs
    command: sh -c
      '
      ([ -z "${SENTRY_DSN:-}" ] || echo "VITE_SENTRY_DSN=${SENTRY_DSN:---}" >> .env) &&
      ([ -z "$ENV" ] || echo "VITE_STAGE=${ENV:---}" >> .env) &&
      ([ -z "${SENTRY_SAMPLE_RATE:-}" ] || echo "VITE_SENTRY_SAMPLE_RATE=${SENTRY_SAMPLE_RATE:---}" >> .env) &&

      vite build
      '
      # Note: '{...:-}' (providing an empty default) avoids warnings; used for optional env.vars.

    #|environment:
    #|  - ENV     # e.g. "staging"
    profiles: ['manual']
